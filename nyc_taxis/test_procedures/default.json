{
  "name": "append-no-conflicts",
  "description": "Indexes the whole document corpus using a setup that will lead to a larger indexing throughput than the default settings and produce a smaller index (higher compression rate). Document ids are unique so all index operations are append only. After that a couple of queries are run.",
  "default": true,
  "schedule": [
    {
      "parallel": {
        "tasks": [
          {
            "name": "expensive-query-1",
            "operation": {
              "operation-type": "search",
              "body": {
                "size": 0,
                "query": {
                  "bool": {
                    "must": [
                      {
                        "range": {
                          "pickup_datetime": {
                            "gte": "2010-01-01 00:00:00",
                            "lte": "2030-12-31 23:59:59"
                          }
                        }
                      },
                      {
                        "range": {
                          "dropoff_datetime": {
                            "gte": "2010-01-01 00:00:00",
                            "lte": "2030-12-31 23:59:59"
                          }
                        }
                      },
                      {
                        "wildcard": {
                          "vendor_id": "*"
                        }
                      },
                      {
                        "geo_bounding_box": {
                          "pickup_location": {
                            "top_left": {
                              "lat": 40.9153,
                              "lon": -74.2591
                            },
                            "bottom_right": {
                              "lat": 40.4774,
                              "lon": -73.7004
                            }
                          }
                        }
                      }
                    ]
                  }
                },
                "aggs": {
                  "vendor_id_terms": {
                    "terms": {
                      "field": "vendor_id",
                      "size": 50,
                      "execution_hint": "map"
                    },
                    "aggs": {
                      "trip_type_terms": {
                        "terms": {
                          "field": "trip_type",
                          "size": 10,
                          "execution_hint": "map"
                        },
                        "aggs": {
                          "payment_type_terms": {
                            "terms": {
                              "field": "payment_type",
                              "size": 10,
                              "execution_hint": "map"
                            },
                            "aggs": {
                              "pickup_location_grid": {
                                "geohash_grid": {
                                  "field": "pickup_location",
                                  "precision": 4
                                },
                                "aggs": {
                                  "dropoff_location_grid": {
                                    "geohash_grid": {
                                      "field": "dropoff_location",
                                      "precision": 4
                                    },
                                    "aggs": {
                                      "avg_total_amount": {
                                        "avg": {
                                          "field": "total_amount"
                                        }
                                      },
                                      "sum_tip_amount": {
                                        "sum": {
                                          "field": "tip_amount"
                                        }
                                      },
                                      "pickup_time_histogram": {
                                        "date_histogram": {
                                          "field": "pickup_datetime",
                                          "interval": "week"
                                        },
                                        "aggs": {
                                          "avg_total_amount_per_week": {
                                            "avg": {
                                              "field": "total_amount"
                                            }
                                          },
                                          "moving_avg_total_amount": {
                                            "moving_avg": {
                                              "buckets_path": "avg_total_amount_per_week",
                                              "window": 10,
                                              "model": "linear"
                                            }
                                          }
                                        }
                                      }
                                    }
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            "settings": {
              "index.requests.cache.enable": false
            },
            "warmup-iterations": 50000,
            "iterations": 1000000,
            "target-throughput": 1000
          },
          {
            "name": "expensive-query-2",
            "operation": {
              "operation-type": "search",
              "body": {
                "size": 0,
                "query": {
                  "bool": {
                    "must": [
                      {
                        "range": {
                          "pickup_datetime": {
                            "gte": "2010-01-01 00:00:00",
                            "lte": "2030-12-31 23:59:59"
                          }
                        }
                      },
                      {
                        "range": {
                          "dropoff_datetime": {
                            "gte": "2010-01-01 00:00:00",
                            "lte": "2030-12-31 23:59:59"
                          }
                        }
                      },
                      {
                        "wildcard": {
                          "vendor_id": "*xyz*"
                        }
                      }
                    ]
                  }
                },
                "aggs": {
                  "vendor_id_terms": {
                    "terms": {
                      "field": "vendor_id",
                      "size": 50,
                      "execution_hint": "map"
                    },
                    "aggs": {
                      "trip_type_terms": {
                        "terms": {
                          "field": "trip_type",
                          "size": 10,
                          "execution_hint": "map"
                        },
                        "aggs": {
                          "payment_type_terms": {
                            "terms": {
                              "field": "payment_type",
                              "size": 10,
                              "execution_hint": "map"
                            },
                            "aggs": {
                              "pickup_location_grid": {
                                "geohash_grid": {
                                  "field": "pickup_location",
                                  "precision": 4
                                },
                                "aggs": {
                                  "dropoff_location_grid": {
                                    "geohash_grid": {
                                      "field": "dropoff_location",
                                      "precision": 4
                                    },
                                    "aggs": {
                                      "avg_total_amount": {
                                        "avg": {
                                          "field": "total_amount"
                                        }
                                      },
                                      "sum_tip_amount": {
                                        "sum": {
                                          "field": "tip_amount"
                                        }
                                      }
                                    }
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            "settings": {
              "index.requests.cache.enable": false
            },
            "warmup-iterations": 50000,
            "iterations": 10000000,
            "target-throughput": 1000
          }
        ]
      }
    }
  ]
},
    {
      "name": "append-no-conflicts-index-only",
      "description": "Indexes the whole document corpus using a setup that will lead to a larger indexing throughput than the default settings and produce a smaller index (higher compression rate). Document ids are unique so all index operations are append only.",
      "schedule": [
        {
          "operation": "delete-index"
        },
        {
          "operation": {
            "operation-type": "create-index",
            "settings": {%- if index_settings is defined %} {{index_settings | tojson}} {%- else %} {
              "index.codec": "best_compression",
              "index.refresh_interval": "30s",
              "index.translog.flush_threshold_size": "4g"
            }{%- endif %}
          }
        },
        {
          "name": "check-cluster-health",
          "operation": {
            "operation-type": "cluster-health",
            "index": "nyc_taxis",
            "request-params": {
              "wait_for_status": "{{cluster_health | default('green')}}",
              "wait_for_no_relocating_shards": "true"
            },
            "retry-until-success": true
          }
        },
        {
          "operation": "index",
          "warmup-time-period": 240,
          "clients": {{bulk_indexing_clients | default(8)}},
          "ignore-response-error-level": "{{error_level | default('non-fatal')}}"
        },
        {
          "name": "refresh-after-index",
          "operation": "refresh"
        },
        {
          "operation": {
            "operation-type": "force-merge",
            "request-timeout": 7200{%- if force_merge_max_num_segments is defined %},
            "max-num-segments": {{ force_merge_max_num_segments | tojson }}
            {%- endif %}
          }
        },
        {
          "name": "refresh-after-force-merge",
          "operation": "refresh"
        },
        {
          "operation": "wait-until-merges-finish"
        }
      ]
    },
    {
      "name": "append-sorted-no-conflicts-index-only",
      "description": "Indexes the whole document corpus in an index sorted by pickup_datetime field in descending order (most recent first) and using a setup that will lead to a larger indexing throughput than the default settings and produce a smaller index (higher compression rate). Document ids are unique so all index operations are append only.",
      "schedule": [
        {
          "operation": "delete-index"
        },
        {
          "operation": {
            "operation-type": "create-index",
            "settings": {%- if index_settings is defined %} {{index_settings | tojson}} {%- else %} {
              "index.codec": "best_compression",
              "index.refresh_interval": "30s",
              "index.translog.flush_threshold_size": "4g",
              "index.sort.field": "pickup_datetime",
              "index.sort.order": "desc"
            }{%- endif %}
          }
        },
        {
          "name": "check-cluster-health",
          "operation": {
            "operation-type": "cluster-health",
            "index": "nyc_taxis",
            "request-params": {
              "wait_for_status": "{{cluster_health | default('green')}}",
              "wait_for_no_relocating_shards": "true"
            },
            "retry-until-success": true
          }
        },
        {
          "operation": "index",
          "warmup-time-period": 240,
          "clients": {{bulk_indexing_clients | default(8)}},
          "ignore-response-error-level": "{{error_level | default('non-fatal')}}"
        },
        {
          "name": "refresh-after-index",
          "operation": "refresh"
        },
        {
          "operation": {
            "operation-type": "force-merge",
            "request-timeout": 7200{%- if force_merge_max_num_segments is defined %},
            "max-num-segments": {{ force_merge_max_num_segments | tojson }}
            {%- endif %}
          }
        },
        {
          "name": "refresh-after-force-merge",
          "operation": "refresh"
        },
        {
          "operation": "wait-until-merges-finish"
        }
      ]
    },
    {
      "name": "update",
      "schedule": [
        {
          "operation": "delete-index"
        },
        {
          "operation": {
            "operation-type": "create-index",
            "settings": {%- if index_settings is defined %} {{index_settings | tojson}} {%- else %} {
              "index.number_of_shards": {{number_of_shards | default(1)}},
              "index.number_of_replicas": {{number_of_replicas | default(0)}},
              "index.store.type": "{{store_type | default('fs')}}"
            }{%- endif %}
          }
        },
        {
          "name": "check-cluster-health",
          "operation": {
            "operation-type": "cluster-health",
            "index": "nyc_taxis",
            "request-params": {
              "wait_for_status": "{{cluster_health | default('green')}}",
              "wait_for_no_relocating_shards": "true"
            },
            "retry-until-success": true
          }
        },
        {
          "operation": "update",
          "warmup-time-period": 1200,
          "clients": {{bulk_indexing_clients | default(8)}},
          "ignore-response-error-level": "{{error_level | default('non-fatal')}}"
        },
        {
          "name": "refresh-after-index",
          "operation": "refresh"
        },
        {
          "operation": {
            "operation-type": "force-merge",
            "request-timeout": 7200{%- if force_merge_max_num_segments is defined %},
            "max-num-segments": {{ force_merge_max_num_segments | tojson }}
            {%- endif %}
          }
        },
        {
          "name": "refresh-after-force-merge",
          "operation": "refresh"
        },
        {
          "operation": "wait-until-merges-finish"
        }
      ]
    }
